name: streamer_tracker

services:
    # PostgreSQL Database
    streamer-db:
        image: postgres:15-alpine
        container_name: streamer-db
        restart: unless-stopped
        environment:
            POSTGRES_USER: ${DB_USER:-postgres}
            POSTGRES_PASSWORD: ${DB_PASSWORD:-password}
            POSTGRES_DB: ${DB_NAME:-streamer_tracker}
        # ports:
        #     - '5400:5432'
        volumes:
            - postgres_data:/var/lib/postgresql/data
        networks:
            - streamer-network
        healthcheck:
            test: ['CMD-SHELL', 'pg_isready -U postgres']
            interval: 5s
            timeout: 5s
            retries: 5

    # Node.js Server
    streamer-server:
        build: ./server
        container_name: streamer-server
        restart: unless-stopped
        # ports:
        #     - '3000:3000'
        environment:
            - PORT=3000
            - DB_USER=${DB_USER:-postgres}
            - DB_PASSWORD=${DB_PASSWORD:-password}
            - DB_HOST=streamer-db
            - DB_NAME=${DB_NAME:-streamer_tracker}
            - DB_PORT=5432
            - DATABASE_URL=postgresql://postgres:password@streamer-db:5432/streamer_tracker
            - NODE_ENV=production
        depends_on:
            streamer-db:
                condition: service_healthy
        networks:
            - streamer-network

    # Angular Client (Nginx)
    streamer-client:
        build: ./client
        container_name: streamer-client
        restart: unless-stopped
        # ports:
        #     - '4200:80'
        networks:
            - streamer-network
    
    streamer-cloudflared:
        image: cloudflare/cloudflared:latest
        container_name: streamer-cloudflared
        restart: unless-stopped
        command: tunnel --no-autoupdate run --token eyJhIjoiODUwYmVhYzdiNWQ4YzQwYTYxYzkxYTc5NWJkMzVkMmEiLCJ0IjoiMDI4NjM1ODktNmRlNC00NGJjLThmYmEtNGNiZGNjNjVkMTQwIiwicyI6Ik1UazBaVFV3TmpndE9XUXhZeTAwTmpGbExXRmtNVGd0TnpZd1lXRTVZamxpTnpsaCJ9
        depends_on:
            - streamer-server
            - streamer-client
            - streamer-db
        networks:
            - streamer-network

volumes:
    postgres_data:

networks:
    streamer-network:
        driver: bridge
